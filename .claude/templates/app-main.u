-- app-main.u

-- App name. This is used for naming the database and services (e.g., "MyApp",  "stage-MyApp", "dev-MyApp", etc.).
deploy.appName : Text
deploy.appName = "MyApp"

deploy.stageAppName : Text
deploy.stageAppName =
  use Text ++
  "stage-" ++ appName

deploy.devAppName : Text
deploy.devAppName =
  use Text ++
  "dev-" ++ appName

deploy.deployProd : '{IO, Exception} URI
deploy.deployProd = Cloud.main do
  -- Prod uses default environment
  environment = Environment.default()
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named appName
  serviceHash = deployHttp environment (main database)
  unisonCloudUrl = ServiceName.assign serviceName serviceHash
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "prod"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  unisonCloudUrl

deploy.deployStage : '{IO, Exception} URI
deploy.deployStage = Cloud.main do
  environment = Environment.named stageAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named stageAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "stage"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.deployDev : '{IO, Exception} URI
deploy.deployDev = Cloud.main do
  environment = Environment.named devAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named devAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "stage"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.initializeStorage : Environment ->{Exception, Cloud} Database
deploy.initializeStorage env =
  use Text ++
  dbName = env |> Environment.name ++ "db"
  database = Database.named dbName
  Database.assign database env
  database

{{
main is the top level entry point of the app where we compose all of our interpreters with our routes.

main should be parameterized by environment and is run in a cloud context (see the various deploy functions)
}}
main.main :
  Database ->
  HttpRequest ->
  {Exception, Storage, Remote, Random, Log} HttpResponse
main.main db req =
  use Route <|>
  Route.run (app.routes db) req

{{
Top level routes, all other routes will be composed here and bubbled up to main.main
}}
app.routes =
  use Parser / s
  use Route <|>
  helloWorld = do
    name = route GET (s "hello" / Parser.text)
    ok.text ("Hello, " ++ name)
  helloWorld
