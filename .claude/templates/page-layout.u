-- page-layout.u
{{
IMPORTANT: When copying this template, replace {- HTML_LIB -} with the actual installed
HTML library version (e.g., tapegram_html_2_1_0). Check using list-project-libraries first!

Pages are conditionally rendered as partials or full pages depending on if the request is partial (e.g., via HTMX) or a full page load.
}}

web.page.page :
  [Html] -> [Html] -> '{Route, Environment.Config, Exception, Log} Html
web.page.page main alert =
  do
    if isPartialRequest() then page.partial main alert
    else page.full main alert
    
web.page.isPartialRequest : '{Route, Log} Boolean
web.page.isPartialRequest =
  do Universal.eq (request.header "Hx-Request") ["true"]
  
web.page.page.partial : [Html] -> Html
web.page.page.partial children =
  use List +:
  use {- HTML_LIB -} div
  div [] children

web.page.page.full :
  [Html] -> {Route, Environment.Config, Exception} Html
web.page.page.full children =
  use List +:
  use Path /
  use Text != ++
  use html async
  use {- HTML_LIB -} link text
  env = Config.expect "env"
  heartbeatUrl = baseUrl() / "heartbeat"
  hotReloadScriptJs =
    "    const pageLoadedAt = new Date();\n    \n    async function checkForNewDeploy() {\n      try {\n        const response = await fetch('"
      ++ (heartbeatUrl |> Path.toText)
      ++ "'); // change to your actual endpoint\n        if (!response.ok) return;\n    \n        const data = await response.json();\n        const deployedAt = new Date(data.deployedAt);\n    \n        if (deployedAt > pageLoadedAt) {\n          location.reload();\n        }\n      } catch (e) {\n        console.error('Heartbeat check failed:', e);\n      }\n    }\n    \n    setInterval(checkForNewDeploy, 3000);\n    "
  hotReloadScript =
    script [type' "text/javascript"] [unsafeText hotReloadScriptJs]
  {- HTML_LIB -}.html
    []
    [ {- HTML_LIB -}.head
        []
        [ meta
            [ Attribute.name "viewport"
            , html.content "width=device-width, initial-scale=1"
            ]
        , lang "en"
        , {- HTML_LIB -}.title [] [text "Monorail App"]
        , link [rel "preconnect", href "https://fonts.gstatic.com"]
        , link [rel "preconnect", href "https://fonts.googleapis.com"]
        , link [rel "preconnect", href "https://unpkg.com/"]
        , link
            [ rel "stylesheet"
            , href "https://unpkg.com/@picocss/pico@latest/css/pico.classless.min.css"
            ]
            []
        , script [ src "https://unpkg.com/htmx.org@1.9.12" ] []
        , page.css
        ]
    , body [] [ main [] [ content ]]
    , if env != "prod" then hotReloadScript else html.empty
    ]

web.page.css : Html
web.page.css = {- HTML_LIB -}.style [] [unsafeText css.raw]

{{
This is where all the custom css goes
}}
web.page.css.raw : Text
web.page.css.raw =
  """
  :not(:defined) {
    visibility: hidden;
  }
  
  [data-loading] {
    display: none;
  } 
  
  .htmx-indicator{
        opacity:0;
        transition: opacity 500ms ease-in;
    }
  .htmx-request .htmx-indicator{
      opacity:1;
  }
  .htmx-request.htmx-indicator{
      opacity:1;
  }
  """

  
  
{{
Base URL helper. Necessary when generating any links in <a> tags or forms.
This is because unison apps are all deployed on the same domain with unique path prefixes.

For example /s/stage-app/<rest of the url>, or by hash /h/<some hash>/<rest of the url>
}}
web.baseUrl : '{Route} Path
web.baseUrl = do basePath (Headers request.headers())
