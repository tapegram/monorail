-- {{pascalCase typeName}} JSON Mappers
-- Generated by Monorail (plop)

-- =============================================================================
-- TYPE DEFINITION
-- =============================================================================

type {{pascalCase typeName}} =
  { {{#each fields}}{{name}} : {{type}}{{#unless @last}}
  , {{/unless}}{{/each}}
  }

-- =============================================================================
-- JSON ENCODER
-- =============================================================================

{{pascalCase typeName}}.encoder : {{pascalCase typeName}} -> Json
{{pascalCase typeName}}.encoder entity =
  object.empty
{{#each fields}}
{{#if (eq type "Text")}}
    |> object.addText "{{name}}" ({{pascalCase ../typeName}}.{{name}} entity)
{{else if (eq type "Nat")}}
    |> object.addNat "{{name}}" ({{pascalCase ../typeName}}.{{name}} entity)
{{else if (eq type "Int")}}
    |> object.addInt "{{name}}" ({{pascalCase ../typeName}}.{{name}} entity)
{{else if (eq type "Float")}}
    |> object.addFloat "{{name}}" ({{pascalCase ../typeName}}.{{name}} entity)
{{else if (eq type "Boolean")}}
    |> object.addBoolean "{{name}}" ({{pascalCase ../typeName}}.{{name}} entity)
{{else if (startsWith type "Optional ")}}
    |> (match {{pascalCase ../typeName}}.{{name}} entity with
          Some v -> object.addText "{{name}}" v
          None -> identity)
{{else if (startsWith type "[")}}
    |> object.addArray "{{name}}" (List.map Json.String ({{pascalCase ../typeName}}.{{name}} entity))
{{else}}
    |> object.addJson "{{name}}" ({{type}}.encoder ({{pascalCase ../typeName}}.{{name}} entity))
{{/if}}
{{/each}}

-- =============================================================================
-- JSON DECODER
-- =============================================================================

{{pascalCase typeName}}.decoder : '{Decoder} {{pascalCase typeName}}
{{pascalCase typeName}}.decoder = do
  use object at! atOptional
{{#each fields}}
{{#if (eq type "Text")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.text
{{else if (eq type "Nat")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.nat
{{else if (eq type "Int")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.int
{{else if (eq type "Float")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.float
{{else if (eq type "Boolean")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.boolean
{{else if (startsWith type "Optional ")}}
  decoded{{pascalCase name}} = atOptional "{{name}}" Decoder.text
{{else if (startsWith type "[")}}
  decoded{{pascalCase name}} = at! "{{name}}" (Decoder.array Decoder.text)
{{else}}
  decoded{{pascalCase name}} = at! "{{name}}" {{type}}.decoder
{{/if}}
{{/each}}
  {{pascalCase typeName}} {{#each fields}}decoded{{pascalCase name}}{{#unless @last}} {{/unless}}{{/each}}

-- =============================================================================
-- CONVENIENCE HELPERS
-- =============================================================================

{{pascalCase typeName}}.encode : {{pascalCase typeName}} -> Text
{{pascalCase typeName}}.encode value = Json.toText ({{pascalCase typeName}}.encoder value)

{{pascalCase typeName}}.decode : Text ->{{openBrace}}Exception} {{pascalCase typeName}}
{{pascalCase typeName}}.decode txt = Decoder.run {{pascalCase typeName}}.decoder txt

-- =============================================================================
-- TESTS
-- =============================================================================

test> {{pascalCase typeName}}.tests.jsonRoundTrip = test.verify do
  original = {{pascalCase typeName}} {{#each fields}}{{#if (eq type "Text")}}"test-{{name}}"{{else if (eq type "Nat")}}42{{else if (eq type "Int")}}+42{{else if (eq type "Float")}}3.14{{else if (eq type "Boolean")}}true{{else if (startsWith type "Optional ")}}(Some "test"){{else if (startsWith type "[")}}["a", "b"]{{else}}(todo "provide test value"){{/if}}{{#unless @last}} {{/unless}}{{/each}}
  encoded = {{pascalCase typeName}}.encode original
  decoded = {{pascalCase typeName}}.decode encoded
  ensureEqual original decoded
