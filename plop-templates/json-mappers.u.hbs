-- {{pascalCase entityName}} JSON Mappers
-- Generated by Monorail (plop)
--
-- REQUIRED LIBRARIES:
--   @unison/json        (Json, Decoder, object.empty, object.addText, etc.)

-- =============================================================================
-- JSON MAPPERS
-- =============================================================================

app.domain.{{pascalCase entityName}}.encoder : app.domain.{{pascalCase entityName}} -> Json
app.domain.{{pascalCase entityName}}.encoder entity =
  object.empty
    |> object.addText "id" (app.domain.{{pascalCase entityName}}.id entity)
{{#each fields}}
{{#if (eq type "Text")}}
    |> object.addText "{{name}}" (app.domain.{{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Nat")}}
    |> object.addNat "{{name}}" (app.domain.{{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Int")}}
    |> object.addInt "{{name}}" (app.domain.{{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Float")}}
    |> object.addFloat "{{name}}" (app.domain.{{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Boolean")}}
    |> object.addBoolean "{{name}}" (app.domain.{{pascalCase ../entityName}}.{{name}} entity)
{{else if (startsWith type "Optional ")}}
    |> (match app.domain.{{pascalCase ../entityName}}.{{name}} entity with
          Some v -> object.add{{substring type 9}} "{{name}}" v
          None -> identity)
{{else if (startsWith type "[")}}
    |> object.addArray "{{name}}" (List.map Json.String (app.domain.{{pascalCase ../entityName}}.{{name}} entity))
{{else}}
    |> object.addJson "{{name}}" ({{type}}.encoder (app.domain.{{pascalCase ../entityName}}.{{name}} entity))
{{/if}}
{{/each}}

app.domain.{{pascalCase entityName}}.decoder : '{Decoder} app.domain.{{pascalCase entityName}}
app.domain.{{pascalCase entityName}}.decoder = do
  use object at! atOptional
  decodedId = at! "id" Decoder.text
{{#each fields}}
{{#if (eq type "Text")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.text
{{else if (eq type "Nat")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.nat
{{else if (eq type "Int")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.int
{{else if (eq type "Float")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.float
{{else if (eq type "Boolean")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.boolean
{{else if (startsWith type "Optional ")}}
  decoded{{pascalCase name}} = atOptional "{{name}}" Decoder.{{lowercase (substring type 9)}}
{{else if (startsWith type "[")}}
  decoded{{pascalCase name}} = at! "{{name}}" (Decoder.array Decoder.text)
{{else}}
  decoded{{pascalCase name}} = at! "{{name}}" {{type}}.decoder
{{/if}}
{{/each}}
  app.domain.{{pascalCase entityName}} decodedId{{#each fields}} decoded{{pascalCase name}}{{/each}}

app.domain.{{pascalCase entityName}}.encode : app.domain.{{pascalCase entityName}} -> Text
app.domain.{{pascalCase entityName}}.encode entity = Json.toText (app.domain.{{pascalCase entityName}}.encoder entity)

app.domain.{{pascalCase entityName}}.decode : Text ->{{openBrace}}Exception} app.domain.{{pascalCase entityName}}
app.domain.{{pascalCase entityName}}.decode txt = Decoder.run app.domain.{{pascalCase entityName}}.decoder txt

-- JSON round-trip test
test> app.domain.{{pascalCase entityName}}.tests.jsonRoundTrip = test.verify do
  original = app.domain.{{pascalCase entityName}} "test-123"{{#each fields}}{{#if (eq type "Text")}} "test-{{name}}"{{else if (eq type "Nat")}} 42{{else if (eq type "Int")}} +42{{else if (eq type "Float")}} 3.14{{else if (eq type "Boolean")}} true{{else if (startsWith type "Optional ")}} (Some "test"){{else if (startsWith type "[")}} ["a", "b"]{{else}} (todo "provide test value"){{/if}}{{/each}}
  encoded = app.domain.{{pascalCase entityName}}.encode original
  decoded = app.domain.{{pascalCase entityName}}.decode encoded
  ensureEqual original decoded
