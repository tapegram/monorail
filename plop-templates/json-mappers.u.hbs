
-- =============================================================================
-- JSON MAPPERS
-- =============================================================================

{{pascalCase entityName}}.encoder : {{pascalCase entityName}} -> Json
{{pascalCase entityName}}.encoder entity =
  object.empty
    |> object.addText "id" ({{pascalCase entityName}}.id entity)
{{#each fields}}
{{#if (eq type "Text")}}
    |> object.addText "{{name}}" ({{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Nat")}}
    |> object.addNat "{{name}}" ({{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Int")}}
    |> object.addInt "{{name}}" ({{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Float")}}
    |> object.addFloat "{{name}}" ({{pascalCase ../entityName}}.{{name}} entity)
{{else if (eq type "Boolean")}}
    |> object.addBoolean "{{name}}" ({{pascalCase ../entityName}}.{{name}} entity)
{{else if (startsWith type "Optional ")}}
    |> (match {{pascalCase ../entityName}}.{{name}} entity with
          Some v -> object.add{{substring type 9}} "{{name}}" v
          None -> identity)
{{else if (startsWith type "[")}}
    |> object.addArray "{{name}}" (List.map Json.String ({{pascalCase ../entityName}}.{{name}} entity))
{{else}}
    |> object.addJson "{{name}}" ({{type}}.encoder ({{pascalCase ../entityName}}.{{name}} entity))
{{/if}}
{{/each}}

{{pascalCase entityName}}.decoder : '{Decoder} {{pascalCase entityName}}
{{pascalCase entityName}}.decoder = do
  use object at! atOptional
  decodedId = at! "id" Decoder.text
{{#each fields}}
{{#if (eq type "Text")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.text
{{else if (eq type "Nat")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.nat
{{else if (eq type "Int")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.int
{{else if (eq type "Float")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.float
{{else if (eq type "Boolean")}}
  decoded{{pascalCase name}} = at! "{{name}}" Decoder.boolean
{{else if (startsWith type "Optional ")}}
  decoded{{pascalCase name}} = atOptional "{{name}}" Decoder.{{lowercase (substring type 9)}}
{{else if (startsWith type "[")}}
  decoded{{pascalCase name}} = at! "{{name}}" (Decoder.array Decoder.text)
{{else}}
  decoded{{pascalCase name}} = at! "{{name}}" {{type}}.decoder
{{/if}}
{{/each}}
  {{pascalCase entityName}} decodedId{{#each fields}} decoded{{pascalCase name}}{{/each}}

{{pascalCase entityName}}.encode : {{pascalCase entityName}} -> Text
{{pascalCase entityName}}.encode entity = Json.toText ({{pascalCase entityName}}.encoder entity)

{{pascalCase entityName}}.decode : Text ->{{openBrace}}Exception} {{pascalCase entityName}}
{{pascalCase entityName}}.decode txt = Decoder.run {{pascalCase entityName}}.decoder txt

-- JSON round-trip test
test> {{pascalCase entityName}}.tests.jsonRoundTrip = test.verify do
  original = {{pascalCase entityName}} "test-123"{{#each fields}}{{#if (eq type "Text")}} "test-{{name}}"{{else if (eq type "Nat")}} 42{{else if (eq type "Int")}} +42{{else if (eq type "Float")}} 3.14{{else if (eq type "Boolean")}} true{{else if (startsWith type "Optional ")}} (Some "test"){{else if (startsWith type "[")}} ["a", "b"]{{else}} (todo "provide test value"){{/if}}{{/each}}
  encoded = {{pascalCase entityName}}.encode original
  decoded = {{pascalCase entityName}}.decode encoded
  ensureEqual original decoded
