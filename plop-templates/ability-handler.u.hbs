-- {{pascalCase abilityName}} Port & Adapter
-- Generated by Monorail (plop)
--
-- REQUIRED LIBRARIES:
--   @unison/cloud       (Database, OrderedTable - if storage adapter)
--   @unison/http        (HttpRequest, HttpResponse - if HTTP adapter)

-- =============================================================================
-- ABILITY (PORT)
-- =============================================================================

ability {{pascalCase abilityName}} where
{{#each operations}}
  {{name}} : {{#if (eq inputType "()")}}'{{openBrace}}{{pascalCase ../abilityName}}{{closeBrace}} {{outputType}}{{else}}{{inputType}} ->{{openBrace}}{{pascalCase ../abilityName}}{{closeBrace}} {{outputType}}{{/if}}
{{/each}}

-- =============================================================================
-- ADAPTER (HANDLER)
-- =============================================================================

{{#if (eq adapterType "Database (OrderedTable)")}}
{{pascalCase abilityName}}.run :
  Database ->
  '{g, {{pascalCase abilityName}}{{closeBrace}} a ->
  {g, Remote} a
{{pascalCase abilityName}}.run db computation =
  -- TODO: Define your table
  -- table = OrderedTable.named db "tablename" Universal.ordering

  go : '{g, {{pascalCase abilityName}}{{closeBrace}} a -> {g, Remote} a
  go comp = handle !comp with cases
{{#each operations}}
    {{openBrace}}{{pascalCase ../abilityName}}.{{name}} {{#unless (eq inputType "()")}}opInput {{/unless}}-> resume} ->
      result = todo "Implement {{name}} with database"
      go '(resume result)

{{/each}}
    {k} -> k

  go computation
{{else if (eq adapterType "HTTP API")}}
{{pascalCase abilityName}}.run :
  Text ->
  '{g, {{pascalCase abilityName}}{{closeBrace}} a ->
  {g, Http, Exception} a
{{pascalCase abilityName}}.run baseApiUrl computation =
  go : '{g, {{pascalCase abilityName}}{{closeBrace}} a -> {g, Http, Exception} a
  go comp = handle !comp with cases
{{#each operations}}
    {{openBrace}}{{pascalCase ../abilityName}}.{{name}} {{#unless (eq inputType "()")}}opInput {{/unless}}-> resume} ->
      uri =
        fromPath (root / "{{name}}")
          |> URI.https
          |> URI.withHost baseApiUrl
      req = HttpRequest.get uri
            |> HttpRequest.addHeader "Accept" "application/json"
      resp = Http.request req
      _ = ensureSuccess resp
      result = todo "Parse response for {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go computation
{{else}}
{{pascalCase abilityName}}.run :
  '{g, {{pascalCase abilityName}}{{closeBrace}} a ->
  {g} a
{{pascalCase abilityName}}.run computation =
  go : '{g, {{pascalCase abilityName}}{{closeBrace}} a -> {g} a
  go comp = handle !comp with cases
{{#each operations}}
    {{openBrace}}{{pascalCase ../abilityName}}.{{name}} {{#unless (eq inputType "()")}}opInput {{/unless}}-> resume} ->
      result = todo "Implement {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go computation
{{/if}}

-- =============================================================================
-- USAGE EXAMPLE
-- =============================================================================

{-
-- In a service:
MyService.doSomething : ServiceInput ->{{openBrace}}{{pascalCase abilityName}}{{closeBrace}} Output
MyService.doSomething serviceInput =
{{#if operations.[0]}}
  result = {{pascalCase abilityName}}.{{operations.[0].name}} {{#unless (eq operations.[0].inputType "()")}}serviceInput{{else}}(){{/unless}}
{{/if}}
  todo "business logic"

-- In main/controller (with real adapter):
{{#if (eq adapterType "Database (OrderedTable)")}}
{{pascalCase abilityName}}.run database do MyService.doSomething serviceInput
{{else if (eq adapterType "HTTP API")}}
{{pascalCase abilityName}}.run "api.example.com" do MyService.doSomething serviceInput
{{else}}
{{pascalCase abilityName}}.run do MyService.doSomething serviceInput
{{/if}}

-- In tests (with fake adapter):
test> MyService.tests.doSomething = test.verify do
  result = todo "Use fake adapter when implemented"
  ensureEqual result expected
-}
