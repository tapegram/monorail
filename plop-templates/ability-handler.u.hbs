-- {{pascalCase abilityName}} Port & Adapter
-- Generated by Monorail (plop)

-- =============================================================================
-- ABILITY (PORT)
-- =============================================================================

ability {{pascalCase abilityName}} where
{{#each operations}}
  {{name}} : {{#if (eq inputType "()")}}'{{"{"}}{{pascalCase ../abilityName}}} {{outputType}}{{else}}{{inputType}} ->{{"{"}}{{pascalCase ../abilityName}}} {{outputType}}{{/if}}
{{/each}}

-- =============================================================================
-- ADAPTER (HANDLER)
-- =============================================================================

{{#if (eq adapterType "Database (OrderedTable)")}}
{{pascalCase abilityName}}.run :
  Database ->
  '{g, {{pascalCase abilityName}}} a ->
  {g, Remote} a
{{pascalCase abilityName}}.run db p =
  -- TODO: Define your table
  -- table = OrderedTable.named db "tablename" Universal.ordering

  go : '{g, {{pascalCase abilityName}}} a -> {g, Remote} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#unless (eq inputType "()")}}input {{/unless}}-> resume} ->
      result = todo "Implement {{name}} with database"
      go '(resume result)

{{/each}}
    {k} -> k

  go p
{{else if (eq adapterType "HTTP API")}}
{{pascalCase abilityName}}.run :
  Text ->
  '{g, {{pascalCase abilityName}}} a ->
  {g, Http, Exception} a
{{pascalCase abilityName}}.run baseUrl p =
  go : '{g, {{pascalCase abilityName}}} a -> {g, Http, Exception} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#unless (eq inputType "()")}}input {{/unless}}-> resume} ->
      uri =
        fromPath (root / "{{name}}")
          |> URI.https
          |> URI.withHost baseUrl
      req = HttpRequest.get uri
            |> HttpRequest.addHeader "Accept" "application/json"
      resp = Http.request req
      _ = ensureSuccess resp
      result = todo "Parse response for {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go p
{{else}}
{{pascalCase abilityName}}.run :
  '{g, {{pascalCase abilityName}}} a ->
  {g} a
{{pascalCase abilityName}}.run p =
  go : '{g, {{pascalCase abilityName}}} a -> {g} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#unless (eq inputType "()")}}input {{/unless}}-> resume} ->
      result = todo "Implement {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go p
{{/if}}

{{#if includeFake}}
-- =============================================================================
-- FAKE ADAPTER (FOR TESTING)
-- =============================================================================

{{pascalCase abilityName}}.fake :
  '{g, {{pascalCase abilityName}}} a ->
  {g} a
{{pascalCase abilityName}}.fake p =
  go : '{g, {{pascalCase abilityName}}} a -> {g} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#unless (eq inputType "()")}}input {{/unless}}-> resume} ->
      result = todo "Fake implementation for {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go p
{{/if}}

-- =============================================================================
-- USAGE EXAMPLE
-- =============================================================================

{-
-- In a service:
MyService.doSomething : Input ->{{"{"}}{{pascalCase abilityName}}} Output
MyService.doSomething input =
{{#if operations.[0]}}
  result = {{pascalCase abilityName}}.{{operations.[0].name}} {{#unless (eq operations.[0].inputType "()")}}input{{else}}(){{/unless}}
{{/if}}
  todo "business logic"

-- In main/controller (with real adapter):
{{#if (eq adapterType "Database (OrderedTable)")}}
handle MyService.doSomething input with {{pascalCase abilityName}}.run database
{{else if (eq adapterType "HTTP API")}}
handle MyService.doSomething input with {{pascalCase abilityName}}.run "api.example.com"
{{else}}
handle MyService.doSomething input with {{pascalCase abilityName}}.run
{{/if}}

-- In tests (with fake adapter):
test> MyService.tests.doSomething = test.verify do
  result = handle MyService.doSomething testInput with {{pascalCase abilityName}}.fake
  ensureEqual result expected
-}
