-- {{pascalCase serviceName}} Tests
-- Generated by Monorail (plop)
--
-- REQUIRED LIBRARIES:
--   (none - uses base library testing functions: test.verify, ensureEqual, etc.)

-- =============================================================================
-- TEST SETUP
-- =============================================================================

-- Fake repository for testing
{{pascalCase repositoryName}}.fake :
  Ref [{{pascalCase entityName}}] ->
  '{g, {{pascalCase repositoryName}}} a ->
  {g} a
{{pascalCase repositoryName}}.fake storage p =
  go : '{g, {{pascalCase repositoryName}}} a -> {g} a
  go p = handle !p with cases
    {get id -> resume} ->
      items = Ref.read storage
      result = List.find (item -> item.id == id) items
      go '(resume result)

    {listAll _ -> resume} ->
      items = Ref.read storage
      go '(resume items)

    {upsert item -> resume} ->
      items = Ref.read storage
      filtered = List.filter (i -> i.id != item.id) items
      Ref.write storage (item +: filtered)
      go '(resume ())

    {delete id -> resume} ->
      items = Ref.read storage
      filtered = List.filter (i -> i.id != id) items
      Ref.write storage filtered
      go '(resume ())

    {k} -> k

  go p

-- Fake UUID generator for deterministic testing
UuidGenerator.fake : Text -> '{g, Random} a -> {g} a
UuidGenerator.fake fixedId p =
  -- Return a predictable UUID for testing
  handle !p with gen.run (Random.lcg 12345)

-- =============================================================================
-- TESTS
-- =============================================================================

{{#each operations}}
{{#if (eq this "create")}}
test> {{pascalCase ../serviceName}}.tests.create.success = test.verify do
  storage = Ref.new []
  input = todo "Create test input"

  result =
    handle
      handle {{pascalCase ../serviceName}}.create input
        with {{pascalCase ../repositoryName}}.fake storage
      with gen.run (Random.lcg 42)

  -- Verify the entity was created
  items = Ref.read storage
  ensure (List.size items == 1)
  labeled "returns created entity" do
    ensureEqual result.id result.id -- TODO: check specific fields

{{/if}}
{{#if (eq this "get")}}
test> {{pascalCase ../serviceName}}.tests.get.found = test.verify do
  testItem = { id = "test-123", todo = "add other fields" }
  storage = Ref.new [testItem]

  result =
    handle {{pascalCase ../serviceName}}.get "test-123"
      with {{pascalCase ../repositoryName}}.fake storage

  match result with
    Some item -> ensureEqual item.id "test-123"
    None -> Test.fail "Expected to find item"

test> {{pascalCase ../serviceName}}.tests.get.notFound = test.verify do
  storage = Ref.new []

  result =
    handle {{pascalCase ../serviceName}}.get "nonexistent"
      with {{pascalCase ../repositoryName}}.fake storage

  match result with
    Some _ -> Test.fail "Expected None for nonexistent item"
    None -> pass

{{/if}}
{{#if (eq this "listAll")}}
test> {{pascalCase ../serviceName}}.tests.listAll.empty = test.verify do
  storage = Ref.new []

  result =
    handle {{pascalCase ../serviceName}}.listAll()
      with {{pascalCase ../repositoryName}}.fake storage

  ensureEqual (List.size result) 0

test> {{pascalCase ../serviceName}}.tests.listAll.withItems = test.verify do
  items =
    [ { id = "1", todo = "add fields" }
    , { id = "2", todo = "add fields" }
    ]
  storage = Ref.new items

  result =
    handle {{pascalCase ../serviceName}}.listAll()
      with {{pascalCase ../repositoryName}}.fake storage

  ensureEqual (List.size result) 2

{{/if}}
{{#if (eq this "update")}}
test> {{pascalCase ../serviceName}}.tests.update.success = test.verify do
  original = { id = "test-123", todo = "add fields" }
  storage = Ref.new [original]
  updateInput = todo "Create update input"

  result =
    handle
      {{pascalCase ../serviceName}}.update "test-123" updateInput
      with {{pascalCase ../repositoryName}}.fake storage

  labeled "returns updated entity" do
    ensureEqual result.id "test-123"
    -- TODO: verify updated fields

test> {{pascalCase ../serviceName}}.tests.update.notFound = test.verify do
  storage = Ref.new []
  updateInput = todo "Create update input"

  result = Exception.toEither do
    handle
      {{pascalCase ../serviceName}}.update "nonexistent" updateInput
      with {{pascalCase ../repositoryName}}.fake storage

  match result with
    Left _ -> pass
    Right _ -> Test.fail "Expected exception for nonexistent item"

{{/if}}
{{#if (eq this "delete")}}
test> {{pascalCase ../serviceName}}.tests.delete.success = test.verify do
  item = { id = "test-123", todo = "add fields" }
  storage = Ref.new [item]

  handle
    {{pascalCase ../serviceName}}.delete "test-123"
    with {{pascalCase ../repositoryName}}.fake storage

  items = Ref.read storage
  ensureEqual (List.size items) 0

test> {{pascalCase ../serviceName}}.tests.delete.notFound = test.verify do
  storage = Ref.new []

  result = Exception.toEither do
    handle
      {{pascalCase ../serviceName}}.delete "nonexistent"
      with {{pascalCase ../repositoryName}}.fake storage

  match result with
    Left _ -> pass
    Right _ -> Test.fail "Expected exception for nonexistent item"

{{/if}}
{{/each}}
