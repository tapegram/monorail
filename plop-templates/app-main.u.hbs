-- {{pascalCase appName}} - Main Application
-- Generated by Monorail (plop)

-- =============================================================================
-- APP CONFIGURATION
-- =============================================================================

deploy.appName : Text
deploy.appName = "{{pascalCase appName}}"

deploy.stageAppName : Text
deploy.stageAppName =
  use Text ++
  "stage-" ++ appName

deploy.devAppName : Text
deploy.devAppName =
  use Text ++
  "dev-" ++ appName

-- =============================================================================
-- DEPLOYMENT FUNCTIONS
-- =============================================================================

deploy.deployProd : '{IO, Exception} URI
deploy.deployProd = Cloud.main do
  environment = Environment.default()
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named appName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "prod"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.deployStage : '{IO, Exception} URI
deploy.deployStage = Cloud.main do
  environment = Environment.named stageAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named stageAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "stage"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.deployDev : '{IO, Exception} URI
deploy.deployDev = Cloud.main do
  environment = Environment.named devAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named devAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "dev"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.initializeStorage : Environment ->{Exception, Cloud} Database
deploy.initializeStorage env =
  use Text ++
  dbName = env |> Environment.name ++ "db"
  database = Database.named dbName
  Database.assign database env
  database

-- =============================================================================
-- MAIN ENTRY POINT
-- =============================================================================

\{{
main is the top level entry point of the app where we compose all of our interpreters with our routes.

main should be parameterized by environment and is run in a cloud context (see the various deploy functions)
}}
main.main :
  Database ->
  HttpRequest ->
  {Exception, Storage, Remote, Random, Log, Environment.Config} HttpResponse
main.main db req =
  use Route <|>
  Route.run (app.routes db) req

-- =============================================================================
-- ROUTES
-- =============================================================================

\{{
Top level routes, all other routes will be composed here and bubbled up to main.main
}}
app.routes :
  Database ->
  '{Route, Log, Exception, Environment.Config} ()
app.routes db =
  use Parser / s
  use Route <|>

  -- Health check / heartbeat
  heartbeat = do
    noCapture GET (s "heartbeat")
    deployedAt = Config.expect "deployedAt"
    json = object.empty |> object.addText "deployedAt" deployedAt
    ok.json json

  -- Home page
  home = do
    noCapture GET (s "")
    html = app.pages.home ()
    renderedHtml = !(web.page.page [html] [])
    ok.html ({{htmlLib}}.toText renderedHtml)

  heartbeat <|> home

-- =============================================================================
-- HOME PAGE
-- =============================================================================

app.pages.home : '{Route} Html
app.pages.home = do
  use {{htmlLib}} article h1 p section text

  article []
    [ h1 [] [text "Welcome to {{pascalCase appName}}"]
    , section []
        [ p [] [text "Your Unison web application is running!"]
        , p [] [text "Edit this page in app.pages.home"]
        ]
    ]
