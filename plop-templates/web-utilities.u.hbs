-- Web Utilities
-- Generated by Monorail (plop)
--
-- REQUIRED LIBRARIES:
--   @unison/routes      (Route ability, basePath, request.headers)
--   @unison/cloud       (Environment.Config)
--   @tapegram/html      (Html type, HTML elements, toText)

-- =============================================================================
-- PAGE RENDERING
-- =============================================================================

\{{
Pages are conditionally rendered as partials or full pages depending on if the
request is partial (e.g., via HTMX) or a full page load.
}}
web.page.page :
  [Html] -> [Html] -> '{Route, Environment.Config, Exception, Log} Html
web.page.page main alert = do
  if isPartialRequest() then page.partial main
  else page.full main

web.page.isPartialRequest : '{Route, Log} Boolean
web.page.isPartialRequest =
  do Universal.eq (request.header "Hx-Request") ["true"]

web.page.page.partial : [Html] -> Html
web.page.page.partial children =
  use {{htmlLib}} div
  div [] children

web.page.page.full :
  [Html] -> {Route, Environment.Config, Exception} Html
web.page.page.full children =
  use {{htmlLib}} body head html link main meta script style text title
  use Path /

  env = Config.expect "env"
  heartbeatUrl = baseUrl() / "heartbeat"

  -- Hot reload script for development
  hotReloadScriptJs =
    "const pageLoadedAt = new Date();\n" Text.++
    "async function checkForNewDeploy() {\n" Text.++
    "  try {\n" Text.++
    "    const response = await fetch('" Text.++ (heartbeatUrl |> Path.toText) Text.++ "');\n" Text.++
    "    if (!response.ok) return;\n" Text.++
    "    const data = await response.json();\n" Text.++
    "    const deployedAt = new Date(data.deployedAt);\n" Text.++
    "    if (deployedAt > pageLoadedAt) location.reload();\n" Text.++
    "  } catch (e) { console.error('Heartbeat check failed:', e); }\n" Text.++
    "}\n" Text.++
    "setInterval(checkForNewDeploy, 3000);"

  hotReloadScript = script [type_ "text/javascript"] [unsafeText hotReloadScriptJs]

  html [lang "en"]
    [ head []
        [ meta [Attribute.name "viewport", content "width=device-width, initial-scale=1"]
        , title [] [text "{{pascalCase appName}}"]
        , link [rel "preconnect", href "https://fonts.gstatic.com"]
        , link [rel "preconnect", href "https://fonts.googleapis.com"]
        , link [rel "preconnect", href "https://unpkg.com/"]
        , link
            [ rel "stylesheet"
            , href "https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
            ]
        , script [src "https://unpkg.com/htmx.org@1.9.12"] []
        , page.css
        ]
    , body []
        [ main [] children
        ]
    , if env != "prod" then hotReloadScript else {{htmlLib}}.empty
    ]

web.page.css : Html
web.page.css = {{htmlLib}}.style [] [unsafeText css.raw]

web.page.css.raw : Text
web.page.css.raw = """
:not(:defined) { visibility: hidden; }
[data-loading] { display: none; }
.htmx-indicator { opacity: 0; transition: opacity 500ms ease-in; }
.htmx-request .htmx-indicator { opacity: 1; }
.htmx-request.htmx-indicator { opacity: 1; }
"""

-- =============================================================================
-- BASE URL HELPER
-- =============================================================================

\{{
Base URL helper. Necessary when generating any links in <a> tags or forms.
This is because Unison apps are deployed on the same domain with unique path prefixes.

For example /s/stage-app/<rest of the url>, or by hash /h/<some hash>/<rest of the url>
}}
web.baseUrl : '{Route} Path
web.baseUrl = do basePath (Headers request.headers())

-- =============================================================================
-- FORM UTILITIES
-- =============================================================================

web.form.getOnly : Text -> Map Text [Text] -> Optional Text
web.form.getOnly name formData = match Map.get name formData with
  Some (value +: _) -> Some value
  _                 -> Optional.None

web.form.getOnly! : Text -> Map Text [Text] ->{Exception} Text
web.form.getOnly! name formData =
  getOnly name formData
    |> (cases
      Some v -> v
      Optional.None ->
        Exception.raise (failure ("Expected form value: " Text.++ name) name))

-- =============================================================================
-- REDIRECT HELPERS
-- =============================================================================

\{{
Redirect to a URL with 303 See Other status.
Use this after form submissions to redirect to a new page.
}}
web.redirect : Text ->{Route} ()
web.redirect url = do
  response.setStatus (HttpResponse.Status.Status 303 "See Other")
  response.headers.add "Location" url

\{{
Redirect to a Path (using baseUrl).
Convenience wrapper that converts Path to Text.
}}
web.redirectTo : Path ->{Route} ()
web.redirectTo path = redirect (Path.toText path)

-- =============================================================================
-- COOKIE HELPERS
-- =============================================================================

\{{
Expire a cookie by setting its max-age to 0.
Use this for logout functionality.
}}
web.cookie.expire : Cookie -> Cookie
web.cookie.expire c = Cookie.maxAge.set (Some (time.Duration.seconds +0)) c

-- =============================================================================
-- THEME PRESETS
-- =============================================================================

\{{
Christmas theme - forest green background with red accents.
}}
web.theme.christmas : Text
web.theme.christmas = """
:root {
  --pico-background-color: #0d2818;
  --pico-color: #e8f5e9;
  --pico-primary: #4caf50;
  --pico-primary-hover: #66bb6a;
  --pico-secondary: #c62828;
  --pico-secondary-hover: #e53935;
  --pico-muted-color: #a5d6a7;
  --pico-muted-border-color: #2e7d32;
  --pico-card-background-color: #1b5e20;
  --pico-card-border-color: #2e7d32;
  --pico-form-element-background-color: #1b5e20;
  --pico-form-element-border-color: #4caf50;
  --pico-form-element-focus-color: #81c784;
}
body { background: linear-gradient(180deg, #0d2818 0%, #1a472a 100%); min-height: 100vh; }
h1, h2, h3 { color: #a5d6a7; }
a { color: #81c784; }
a:hover { color: #a5d6a7; }
button { background-color: #c62828; border-color: #c62828; }
button:hover { background-color: #e53935; border-color: #e53935; }
button[type="submit"] { background-color: #4caf50; border-color: #4caf50; }
button[type="submit"]:hover { background-color: #66bb6a; border-color: #66bb6a; }
input, textarea, select { background-color: #1b5e20; border-color: #4caf50; color: #e8f5e9; }
input::placeholder { color: #81c784; }
"""

\{{
Dark theme - neutral dark background.
}}
web.theme.dark : Text
web.theme.dark = """
:root {
  --pico-background-color: #1a1a2e;
  --pico-color: #eaeaea;
  --pico-primary: #0f3460;
  --pico-primary-hover: #16213e;
  --pico-muted-color: #888;
  --pico-card-background-color: #16213e;
}
"""

\{{
Ocean theme - blue tones.
}}
web.theme.ocean : Text
web.theme.ocean = """
:root {
  --pico-background-color: #0a1628;
  --pico-color: #e0f7fa;
  --pico-primary: #0288d1;
  --pico-primary-hover: #03a9f4;
  --pico-muted-color: #80deea;
  --pico-card-background-color: #01579b;
  --pico-form-element-background-color: #01579b;
  --pico-form-element-border-color: #0288d1;
}
body { background: linear-gradient(180deg, #0a1628 0%, #1a237e 100%); min-height: 100vh; }
h1, h2, h3 { color: #4fc3f7; }
a { color: #4fc3f7; }
button[type="submit"] { background-color: #0288d1; border-color: #0288d1; }
"""
