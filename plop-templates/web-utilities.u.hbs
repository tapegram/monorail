-- Web Utilities
-- Generated by Monorail (plop)
--
-- REQUIRED LIBRARIES:
--   @unison/routes      (Route ability, basePath, request.headers)
--   @unison/cloud       (Environment.Config)
--   @tapegram/html      (Html type, HTML elements, toText)

-- =============================================================================
-- PAGE RENDERING
-- =============================================================================

\{{
Pages are conditionally rendered as partials or full pages depending on if the
request is partial (e.g., via HTMX) or a full page load.
}}
web.page.page :
  [Html] -> [Html] -> '{Route, Environment.Config, Exception, Log} Html
web.page.page main alert = do
  if isPartialRequest() then page.partial main
  else page.full main

web.page.isPartialRequest : '{Route, Log} Boolean
web.page.isPartialRequest =
  do Universal.eq (request.header "Hx-Request") ["true"]

web.page.page.partial : [Html] -> Html
web.page.page.partial children =
  use {{htmlLib}} div
  div [] children

web.page.page.full :
  [Html] -> {Route, Environment.Config, Exception} Html
web.page.page.full children =
  use {{htmlLib}} body head html link main meta script style text title
  use Path /

  env = Config.expect "env"
  heartbeatUrl = baseUrl() / "heartbeat"

  -- Hot reload script for development
  hotReloadScriptJs =
    "const pageLoadedAt = new Date();\n" Text.++
    "async function checkForNewDeploy() {\n" Text.++
    "  try {\n" Text.++
    "    const response = await fetch('" Text.++ (heartbeatUrl |> Path.toText) Text.++ "');\n" Text.++
    "    if (!response.ok) return;\n" Text.++
    "    const data = await response.json();\n" Text.++
    "    const deployedAt = new Date(data.deployedAt);\n" Text.++
    "    if (deployedAt > pageLoadedAt) location.reload();\n" Text.++
    "  } catch (e) { console.error('Heartbeat check failed:', e); }\n" Text.++
    "}\n" Text.++
    "setInterval(checkForNewDeploy, 3000);"

  hotReloadScript = script [type_ "text/javascript"] [unsafeText hotReloadScriptJs]

  html [lang "en"]
    [ head []
        [ meta [Attribute.name "viewport", content "width=device-width, initial-scale=1"]
        , title [] [text "{{pascalCase appName}}"]
        , link [rel "preconnect", href "https://fonts.gstatic.com"]
        , link [rel "preconnect", href "https://fonts.googleapis.com"]
        , link [rel "preconnect", href "https://unpkg.com/"]
        , link
            [ rel "stylesheet"
            , href "https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
            ]
        , script [src "https://unpkg.com/htmx.org@1.9.12"] []
        , page.css
        ]
    , body []
        [ main [] children
        ]
    , if env != "prod" then hotReloadScript else {{htmlLib}}.empty
    ]

web.page.css : Html
web.page.css = {{htmlLib}}.style [] [unsafeText css.raw]

web.page.css.raw : Text
web.page.css.raw = """
:not(:defined) { visibility: hidden; }
[data-loading] { display: none; }
.htmx-indicator { opacity: 0; transition: opacity 500ms ease-in; }
.htmx-request .htmx-indicator { opacity: 1; }
.htmx-request.htmx-indicator { opacity: 1; }
"""

-- =============================================================================
-- BASE URL HELPER
-- =============================================================================

\{{
Base URL helper. Necessary when generating any links in <a> tags or forms.
This is because Unison apps are deployed on the same domain with unique path prefixes.

For example /s/stage-app/<rest of the url>, or by hash /h/<some hash>/<rest of the url>
}}
web.baseUrl : '{Route} Path
web.baseUrl = do basePath (Headers request.headers())

-- =============================================================================
-- FORM UTILITIES
-- =============================================================================

web.form.getOnly : Text -> Map Text [Text] -> Optional Text
web.form.getOnly name formData = match Map.get name formData with
  Some (value +: _) -> Some value
  _                 -> Optional.None

web.form.getOnly! : Text -> Map Text [Text] ->{Exception} Text
web.form.getOnly! name formData =
  getOnly name formData
    |> (cases
      Some v -> v
      Optional.None ->
        Exception.raise (failure ("Expected form value: " Text.++ name) name))

-- =============================================================================
-- REDIRECT HELPERS
-- =============================================================================

\{{
Redirect to a URL with 303 See Other status.
Use this after form submissions to redirect to a new page.
}}
web.redirect : Text ->{Route} ()
web.redirect url = do
  response.setStatus (HttpResponse.Status.Status 303 "See Other")
  response.headers.add "Location" url

\{{
Redirect to a Path (using baseUrl).
Convenience wrapper that converts Path to Text.
}}
web.redirectTo : Path ->{Route} ()
web.redirectTo path = redirect (Path.toText path)

-- =============================================================================
-- COOKIE HELPERS
-- =============================================================================

\{{
Expire a cookie by setting its max-age to 0.
Use this for logout functionality.
}}
web.cookie.expire : Cookie -> Cookie
web.cookie.expire c = Cookie.maxAge.set (Some (time.Duration.seconds +0)) c

-- =============================================================================
-- THEME GENERATION
-- =============================================================================

\{{
Themes are generated from color palettes in .claude/data/color-palettes.jsonl.
See .claude/skills/color-palettes-theming.md for the full list of available palettes.

To apply a theme, ask Claude to generate one from the palette data.
Example: "Apply the teal_stone theme" or "Make it dark mode with the cyber_grape palette"

Available palettes: cool_blue, salmon_charcoal, teal_stone, purple_soft_gray,
lime_graphite, sunset_gold_navy, mint_ink, rose_slate, cyber_grape, earthy_rust_olive

Example theme structure:
}}

web.theme.example : Text
web.theme.example = """
:root {
  --pico-background-color: #FFFFFF;
  --pico-color: #1A1A1A;
  --pico-primary: #3A7AFE;
  --pico-primary-hover: #5A94FF;
  --pico-primary-inverse: #FFFFFF;
  --pico-secondary: #F2F4F7;
  --pico-secondary-hover: #E5E9EE;
  --pico-muted-color: #F2F4F7;
  --pico-muted-border-color: #D0D5DD;
  --pico-card-background-color: #FFFFFF;
  --pico-card-border-color: #D0D5DD;
  --pico-form-element-background-color: #FFFFFF;
  --pico-form-element-border-color: #D0D5DD;
  --pico-form-element-focus-color: #3A7AFE;
}
"""
