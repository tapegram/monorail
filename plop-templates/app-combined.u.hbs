-- Web Utilities
-- Generated by Monorail (plop)

-- =============================================================================
-- PAGE RENDERING
-- =============================================================================

\{{
Pages are conditionally rendered as partials or full pages depending on if the
request is partial (e.g., via HTMX) or a full page load.
}}
web.page.page :
  [Html] -> [Html] -> '{Route, Environment.Config, Exception, Log} Html
web.page.page main alert = do
  if isPartialRequest() then page.partial main
  else page.full main

web.page.isPartialRequest : '{Route, Log} Boolean
web.page.isPartialRequest =
  do Universal.eq (request.header "Hx-Request") ["true"]

web.page.page.partial : [Html] -> Html
web.page.page.partial children =
  use {{htmlLib}} div
  div [] children

web.page.page.full :
  [Html] -> {Route, Environment.Config, Exception} Html
web.page.page.full children =
  use {{htmlLib}} body head html link main meta script style text title
  use Path /

  env = Config.expect "env"
  heartbeatUrl = baseUrl() / "heartbeat"

  -- Hot reload script for development
  hotReloadScriptJs =
    "const pageLoadedAt = new Date();\n" Text.++
    "async function checkForNewDeploy() {\n" Text.++
    "  try {\n" Text.++
    "    const response = await fetch('" Text.++ (heartbeatUrl |> Path.toText) Text.++ "');\n" Text.++
    "    if (!response.ok) return;\n" Text.++
    "    const data = await response.json();\n" Text.++
    "    const deployedAt = new Date(data.deployedAt);\n" Text.++
    "    if (deployedAt > pageLoadedAt) location.reload();\n" Text.++
    "  } catch (e) { console.error('Heartbeat check failed:', e); }\n" Text.++
    "}\n" Text.++
    "setInterval(checkForNewDeploy, 3000);"

  hotReloadScript = script [type_ "text/javascript"] [unsafeText hotReloadScriptJs]

  html [lang "en"]
    [ head []
        [ meta [Attribute.name "viewport", content "width=device-width, initial-scale=1"]
        , title [] [text "{{pascalCase appName}}"]
        , link [rel "preconnect", href "https://fonts.gstatic.com"]
        , link [rel "preconnect", href "https://fonts.googleapis.com"]
        , link [rel "preconnect", href "https://unpkg.com/"]
        , link
            [ rel "stylesheet"
            , href "https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
            ]
        , script [src "https://unpkg.com/htmx.org@1.9.12"] []
        , page.css
        ]
    , body []
        [ main [] children
        ]
    , if env != "prod" then hotReloadScript else {{htmlLib}}.empty
    ]

web.page.css : Html
web.page.css = {{htmlLib}}.style [] [unsafeText css.raw]

web.page.css.raw : Text
web.page.css.raw = """
:not(:defined) { visibility: hidden; }
[data-loading] { display: none; }
.htmx-indicator { opacity: 0; transition: opacity 500ms ease-in; }
.htmx-request .htmx-indicator { opacity: 1; }
.htmx-request.htmx-indicator { opacity: 1; }
"""

-- =============================================================================
-- BASE URL HELPER
-- =============================================================================

\{{
Base URL helper. Necessary when generating any links in <a> tags or forms.
This is because Unison apps are deployed on the same domain with unique path prefixes.

For example /s/stage-app/<rest of the url>, or by hash /h/<some hash>/<rest of the url>
}}
web.baseUrl : '{Route} Path
web.baseUrl = do basePath (Headers request.headers())

-- =============================================================================
-- FORM UTILITIES
-- =============================================================================

web.form.getOnly : Text -> Map Text [Text] -> Optional Text
web.form.getOnly name formData = match Map.get name formData with
  Some (value +: _) -> Some value
  _                 -> Optional.None

web.form.getOnly! : Text -> Map Text [Text] ->{Exception} Text
web.form.getOnly! name formData =
  getOnly name formData
    |> (cases
      Some v -> v
      Optional.None ->
        Exception.raise (failure ("Expected form value: " Text.++ name) name))
-- {{pascalCase appName}} - Main Application
-- Generated by Monorail (plop)

-- =============================================================================
-- APP CONFIGURATION
-- =============================================================================

deploy.appName : Text
deploy.appName = "{{pascalCase appName}}"

deploy.stageAppName : Text
deploy.stageAppName =
  use Text ++
  "stage-" ++ appName

deploy.devAppName : Text
deploy.devAppName =
  use Text ++
  "dev-" ++ appName

-- =============================================================================
-- DEPLOYMENT FUNCTIONS
-- =============================================================================

deploy.deployProd : '{IO, Exception} URI
deploy.deployProd = Cloud.main do
  environment = Environment.default()
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named appName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "prod"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.deployStage : '{IO, Exception} URI
deploy.deployStage = Cloud.main do
  environment = Environment.named stageAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named stageAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "stage"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.deployDev : '{IO, Exception} URI
deploy.deployDev = Cloud.main do
  environment = Environment.named devAppName
  database = deploy.initializeStorage environment
  serviceName = ServiceName.named devAppName
  serviceHash = deployHttp environment (main database)
  setValue environment "deployHash" (serviceHash |> ServiceHash.toText)
  setValue environment "env" "dev"
  setValue environment "deployedAt" (Instant.toText Instant.now())
  ServiceName.assign serviceName serviceHash

deploy.initializeStorage : Environment ->{Exception, Cloud} Database
deploy.initializeStorage env =
  use Text ++
  dbName = env |> Environment.name ++ "db"
  database = Database.named dbName
  Database.assign database env
  database

-- =============================================================================
-- MAIN ENTRY POINT
-- =============================================================================

\{{
main is the top level entry point of the app where we compose all of our interpreters with our routes.

main should be parameterized by environment and is run in a cloud context (see the various deploy functions)
}}
main.main :
  Database ->
  HttpRequest ->
  {Exception, Storage, Remote, Random, Log, Environment.Config} HttpResponse
main.main db req =
  use Route <|>
  Route.run (app.routes db) req

-- =============================================================================
-- ROUTES
-- =============================================================================

\{{
Top level routes, all other routes will be composed here and bubbled up to main.main
}}
app.routes :
  Database ->
  '{Route, Log, Exception, Environment.Config} ()
app.routes db =
  use Parser / s
  use Route <|>

  -- Health check / heartbeat
  heartbeat = do
    noCapture GET (s "heartbeat")
    deployedAt = Config.expect "deployedAt"
    json = object.empty |> object.addText "deployedAt" deployedAt
    ok.json json

  -- Home page
  home = do
    noCapture GET (s "")
    html = app.pages.home ()
    renderedHtml = !(web.page.page [html] [])
    ok.html ({{htmlLib}}.toText renderedHtml)

  heartbeat <|> home

-- =============================================================================
-- HOME PAGE
-- =============================================================================

app.pages.home : '{Route} Html
app.pages.home = do
  use {{htmlLib}} article h1 p section text

  article []
    [ h1 [] [text "Welcome to {{pascalCase appName}}"]
    , section []
        [ p [] [text "Your Unison web application is running!"]
        , p [] [text "Edit this page in app.pages.home"]
        ]
    ]
