-- {{pascalCase clientName}} API Client
-- Generated by Monorail (plop)

-- =============================================================================
-- ABILITY (PORT)
-- =============================================================================

ability {{pascalCase clientName}}Api where
{{#each operations}}
  {{name}} : {{#if inputType}}{{inputType}} ->{{"{"}}{{pascalCase ../clientName}}Api} {{responseType}}{{else}}'{{"{"}}{{pascalCase ../clientName}}Api} {{responseType}}{{/if}}
{{/each}}

-- =============================================================================
-- HTTP ADAPTER
-- =============================================================================

{{pascalCase clientName}}Api.run :
  Text ->
  '{g, {{pascalCase clientName}}Api} a ->
  {g, Http, Exception} a
{{pascalCase clientName}}Api.run baseUrl p =
  go : '{g, {{pascalCase clientName}}Api} a -> {g, Http, Exception} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#if inputType}}input {{/if}}-> resume} ->
      uri =
        fromPath (root{{#each (split endpoint "/")}}{{#if this}} / "{{this}}"{{/if}}{{/each}})
          |> URI.https
          |> URI.withHost baseUrl

{{#if (eq httpMethod "GET")}}
      req = HttpRequest.get uri
            |> HttpRequest.addHeader "Accept" "application/json"
{{else if (eq httpMethod "POST")}}
      req = HttpRequest.post uri
            |> HttpRequest.addHeader "Content-Type" "application/json"
            |> HttpRequest.addHeader "Accept" "application/json"
            -- |> HttpRequest.withBody (Json.toText (encodeInput input))
{{else if (eq httpMethod "PUT")}}
      req = HttpRequest.put uri
            |> HttpRequest.addHeader "Content-Type" "application/json"
            |> HttpRequest.addHeader "Accept" "application/json"
{{else if (eq httpMethod "DELETE")}}
      req = HttpRequest.delete uri
            |> HttpRequest.addHeader "Accept" "application/json"
{{/if}}

      resp = Http.request req
      _ = ensureSuccess resp
{{#if (eq responseType "Json")}}
      body = HttpResponse.bodyText resp
      result = match Json.tryFromText body with
        Right json -> json
        Left err -> Exception.raise (failure "Failed to parse JSON" err)
{{else if (eq responseType "()")}}
      result = ()
{{else}}
      body = HttpResponse.bodyText resp
      result = {{responseType}}.decode body
{{/if}}
      go '(resume result)

{{/each}}
    {k} -> k

  go p

-- =============================================================================
-- FAKE ADAPTER (FOR TESTING)
-- =============================================================================

{{pascalCase clientName}}Api.fake :
  '{g, {{pascalCase clientName}}Api} a ->
  {g} a
{{pascalCase clientName}}Api.fake p =
  go : '{g, {{pascalCase clientName}}Api} a -> {g} a
  go p = handle !p with cases
{{#each operations}}
    { {{name}} {{#if inputType}}input {{/if}}-> resume} ->
      result = todo "Fake response for {{name}}"
      go '(resume result)

{{/each}}
    {k} -> k

  go p

-- =============================================================================
-- USAGE EXAMPLE
-- =============================================================================

{-
-- Using the API client:
myFunction : '{{"{"}}{{pascalCase clientName}}Api} SomeResult
myFunction = do
{{#if operations.[0]}}
  response = {{pascalCase clientName}}Api.{{operations.[0].name}} {{#if operations.[0].inputType}}someInput{{else}}(){{/if}}
{{/if}}
  todo "process response"

-- In main/controller:
handle myFunction() with {{pascalCase clientName}}Api.run "{{baseUrl}}"

-- In tests:
test> myFunction.tests.example = test.verify do
  result = handle myFunction() with {{pascalCase clientName}}Api.fake
  ensureEqual result expected
-}
